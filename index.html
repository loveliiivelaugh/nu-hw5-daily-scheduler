<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
      integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <title>Work Day Scheduler</title>
  </head>

  <body>
    <header class="jumbotron">
      <h1 class="display-3">Work Day Scheduler</h1>
      <p class="lead">A simple calendar app for scheduling your work day</p>
      <p id="currentDay" class="lead"></p>
    </header>
    <div class="container">
      <!-- Timeblocks go here -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script>
      //initialize local storage
      const scheduleStorage = JSON.parse(localStorage.getItem("schedule")) ? JSON.parse(localStorage.getItem("schedule")) : [];

      let d = new Date();
      console.info(moment().hour()) //now accepts 0 - 23

      let year = d.getFullYear()
      let month = d.getMonth() + 1
      let day = d.getDate()

      let totalDays = new Date(year, month, 0).getDate()

      let output = 
      (month < 10 ? '0' : '') + month + '/' +
      (day<10 ? '0' : '') + day + '/' + year

      document.querySelector("#currentDay").innerHTML = output; //change to string using moment.js

      const getDayOfWeek = (day) => {
        switch (day) {
          case 0:
            return "Sunday"
            break
          case 1:
            return "Monday"
            break;
          case 2:
            return "Tuesday"
            break;
            // ....
        }
      }

      const headerCells = [
        {name: " "},
        {name:`Daily's ${getDayOfWeek(d.getDay())} ${output}`},
      ]

      const timeSlots = [
        { time: "5AM", hour: 5 },
        { time: "6AM", hour: 6 },
        { time: "7AM", hour: 7 },
        { time: "8AM", hour: 8 },
        { time: "9AM", hour: 9 },
        { time: "10AM", hour: 10 },
        { time: "11AM", hour: 11 },
        { time: "12PM", hour: 12 },
        { time: "1PM", hour: 13 },
        { time: "2PM", hour: 14 },
        { time: "3PM", hour: 15 },
        { time: "4PM", hour: 16 },
        { time: "5PM", hour: 17 },
        { time: "6PM", hour: 18 },
        { time: "7PM", hour: 19 },
        { time: "8PM", hour: 20 },
        { time: "9PM", hour: 21 },
        { time: "10PM", hour: 22 },
        { time: "11PM", hour: 23 },
        { time: "12AM", hour: 0 },
        { time: "1AM", hour: 1 },
        { time: "2AM", hour: 2 },
        { time: "3AM", hour: 3 },
        { time: "4AM", hour: 4 },
      ]

      const handleCellClick = (event) => {
        console.info(
          "I am clicked?!", 
          event, 
          event.target.value, 
          event.target.id
          )
        scheduleStorage.push({
          date: d,
          cell: event.target.id,
          notes: event.target.value
        })
        localStorage.setItem('schedule', JSON.stringify(scheduleStorage))
      }

      const saveContents = (event) => {
        console.info("i have been clicked!", event)
        //console.info(JSON.parse(localStorage.getItem('schedule')))
        localStorage.setItem('schedule', JSON.stringify(scheduleStorage))
      }

      const getCellContentsById = (id) => {
        for (i = 0; i < scheduleStorage.length; i++) {
          if (id === scheduleStorage[i].cell) {
            return scheduleStorage[i].notes ? scheduleStorage[i].notes : '';
          }
        }
      }

      const setCellBackground = (hour) => {
        if (hour < moment().hour()) { return "past" }
        else if (hour == moment().hour()) { return "present" }
        else if (hour > moment().hour()) { return "future" }
      }
      
      //table component.
      document.querySelector(".container").innerHTML = `
      <table class="table">
        <tbody>
        ${timeSlots.map(timeslot => 
          `<tr id="timeslot-row" class="row" scope="row">
            <td class="hour" scope="col">${timeslot.time}</td>
            ${headerCells.slice(1).map((forEachCell, index) => `
              <td key=${index} class=${setCellBackground(timeslot.hour)}>
                <input 
                  name="cell-contents" 
                  type="text"
                  size="80"
                  class="time-block cell-input"
                  id="${timeslot.time}-cell"
                  onchange="handleCellClick(event)"
                  onclick="handleCellClick(event)"
                  value="${
                    scheduleStorage && 
                    getCellContentsById(timeslot.time + "-cell") ? getCellContentsById(timeslot.time + "-cell") : 
                    ' '
                  }"
                >
                  ${' '}
                </input>
                <button class="saveBtn" click="${event => saveContents(event)}"><i class="fa fa-lock" aria-hidden="true"></i></button>
              </td>
              `)}
            </tr>`
        )}
        </tbody>
      </table>
      `
    </script>
  </body>
</html>
